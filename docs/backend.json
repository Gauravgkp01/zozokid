{
  "entities": {
    "Parent": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Parent",
      "type": "object",
      "description": "Represents a parent user account within KidTube Safe, linked to an external authentication system. Stores core information about the parent.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Parent entity."
        },
        "externalAuthId": {
          "type": "string",
          "description": "Unique identifier from the external authentication system for this parent. Used to link KidTube Safe data to the authenticated user."
        },
        "email": {
          "type": "string",
          "description": "Email address of the parent, provided during registration. Used for identification and communication.",
          "format": "email"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the parent profile was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the parent profile was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "externalAuthId",
        "email",
        "createdAt",
        "updatedAt"
      ]
    },
    "TeacherProfile": {
      "title": "TeacherProfile",
      "type": "object",
      "description": "Represents a teacher user account.",
      "properties": {
        "id": {
          "type": "string"
        },
        "externalAuthId": {
          "type": "string"
        },
        "email": {
          "type": "string",
          "format": "email"
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "externalAuthId",
        "email",
        "createdAt",
        "updatedAt"
      ]
    },
    "Class": {
      "title": "Class",
      "type": "object",
      "description": "Represents a class created by a teacher, containing a list of student profiles.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Class entity."
        },
        "teacherId": {
          "type": "string",
          "description": "The UID of the teacher who created and owns this class."
        },
        "name": {
          "type": "string",
          "description": "The name of the class (e.g., 'Morning Group', 'Grade 2 Reading')."
        },
        "avatarUrl": {
          "type": "string",
          "description": "URL to the class's selected avatar or profile picture.",
          "format": "uri"
        },
        "students": {
          "type": "array",
          "description": "An array of student identifiers that belong to this class.",
          "items": {
            "type": "object",
            "properties": {
              "studentId": {
                "type": "string"
              },
              "parentId": {
                "type": "string"
              }
            },
            "required": [
              "studentId",
              "parentId"
            ]
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the class was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the class was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "teacherId",
        "name",
        "createdAt",
        "updatedAt"
      ]
    },
    "ClassJoinRequest": {
      "title": "ClassJoinRequest",
      "type": "object",
      "description": "Represents a parent's request for their child to join a teacher's class.",
      "properties": {
        "id": {
          "type": "string"
        },
        "classId": {
          "type": "string"
        },
        "className": {
          "type": "string"
        },
        "teacherId": {
          "type": "string"
        },
        "parentId": {
          "type": "string"
        },
        "childProfileId": {
          "type": "string"
        },
        "childName": {
          "type": "string"
        },
        "childAvatarUrl": {
          "type": "string",
          "format": "uri"
        },
        "status": {
          "type": "string",
          "enum": [
            "pending",
            "approved",
            "denied"
          ]
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        },
        "viewers": {
          "type": "array",
          "description": "An array containing the parentId and teacherId, for security rule query purposes.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "classId",
        "className",
        "teacherId",
        "parentId",
        "childProfileId",
        "childName",
        "status",
        "createdAt",
        "viewers"
      ]
    },
    "ChildProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ChildProfile",
      "type": "object",
      "description": "Represents a child's profile created by a parent, including their personalized content filtering preferences.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ChildProfile entity."
        },
        "parentId": {
          "type": "string",
          "description": "Reference to the Parent who created this child profile. (Relationship: Parent 1:N ChildProfile)"
        },
        "name": {
          "type": "string",
          "description": "The name or nickname of the child."
        },
        "age": {
          "type": "number",
          "description": "The child's age, used for age-appropriate content suggestions and filtering."
        },
        "class": {
          "type": "string",
          "description": "The child's current class or grade level.",
          "enum": [
            "Pre-nursery",
            "Nursery",
            "LKG",
            "UKG",
            "1st",
            "2nd",
            "3rd",
            "4th",
            "5th"
          ]
        },
        "avatarUrl": {
          "type": "string",
          "description": "URL to the child's selected avatar or profile picture.",
          "format": "uri"
        },
        "sharedWithTeacherIds": {
          "type": "array",
          "description": "A list of teacher UIDs that have been granted read access to this child's profile by the parent.",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the child profile was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the child profile was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "parentId",
        "name",
        "age",
        "class",
        "createdAt",
        "updatedAt"
      ]
    },
    "Channel": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Channel",
      "type": "object",
      "description": "Represents a YouTube channel that can be referenced in content filters.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Channel entity."
        },
        "youtubeChannelId": {
          "type": "string",
          "description": "The unique identifier for the channel as provided by the YouTube API."
        },
        "name": {
          "type": "string",
          "description": "The public name of the YouTube channel."
        },
        "thumbnailUrl": {
          "type": "string",
          "description": "URL to the channel's thumbnail image.",
          "format": "uri"
        },
        "description": {
          "type": "string",
          "description": "A brief description of the channel's content."
        },
        "url": {
          "type": "string",
          "description": "The URL to the YouTube channel page.",
          "format": "uri"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the channel record was first created in KidTube Safe.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the channel record was last updated in KidTube Safe.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "youtubeChannelId",
        "name",
        "createdAt",
        "updatedAt"
      ]
    },
    "ContentType": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ContentType",
      "type": "object",
      "description": "Represents a category or type of content defined within KidTube Safe (e.g., Educational, Cartoons).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ContentType entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the content type (e.g., 'Educational Videos', 'Animated Shorts')."
        },
        "description": {
          "type": "string",
          "description": "A brief description of what this content type entails."
        },
        "iconUrl": {
          "type": "string",
          "description": "URL to an icon representing this content type in the UI.",
          "format": "uri"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the content type was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the content type was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "createdAt",
        "updatedAt"
      ]
    },
    "VideoWatchEvent": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "VideoWatchEvent",
      "type": "object",
      "description": "Records an instance of a child watching a video, used for analytics and tracking consumption patterns.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the VideoWatchEvent entity."
        },
        "parentId": {
          "type": "string",
          "description": "Denormalized reference to the owning Parent for authorization."
        },
        "childProfileId": {
          "type": "string",
          "description": "Reference to the ChildProfile that watched the video. (Relationship: ChildProfile 1:N VideoWatchEvent)"
        },
        "youtubeVideoId": {
          "type": "string",
          "description": "The unique identifier for the video as provided by the YouTube API."
        },
        "channelId": {
          "type": "string",
          "description": "The ID of the YouTube channel from which the video originated."
        },
        "channelTitle": {
          "type": "string",
          "description": "The title of the YouTube channel at the time it was watched."
        },
        "contentTypeId": {
          "type": "string",
          "description": "Reference to the primary ContentType assigned to this video by KidTube Safe's categorization. (Relationship: ContentType 1:N VideoWatchEvent)"
        },
        "watchDurationSeconds": {
          "type": "number",
          "description": "The duration, in seconds, for which the video was watched by the child."
        },
        "watchedAt": {
          "type": "string",
          "description": "Timestamp indicating when the video watch event occurred.",
          "format": "date-time"
        },
        "videoTitle": {
          "type": "string",
          "description": "The title of the video at the time it was watched (for historical data stability)."
        },
        "videoThumbnailUrl": {
          "type": "string",
          "description": "URL to the thumbnail of the video at the time it was watched.",
          "format": "uri"
        },
        "videoUrl": {
          "type": "string",
          "description": "The URL to the YouTube video at the time it was watched.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "parentId",
        "childProfileId",
        "youtubeVideoId",
        "channelId",
        "channelTitle",
        "watchDurationSeconds",
        "watchedAt"
      ]
    },
    "Video": {
      "title": "Video",
      "type": "object",
      "description": "Represents a YouTube video added by a parent for their children to watch.",
      "properties": {
        "parentId": {
          "type": "string",
          "description": "The UID of the parent who added this video."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp indicating when the video was added."
        },
        "title": {
          "type": "string",
          "description": "The title of the YouTube video."
        },
        "thumbnailUrl": {
          "type": "string",
          "format": "uri",
          "description": "URL of the video thumbnail."
        },
        "channelId": {
          "type": "string",
          "description": "The ID of the YouTube channel this video belongs to."
        },
        "channelTitle": {
          "type": "string",
          "description": "The title of the YouTube channel this video belongs to."
        }
      },
      "required": [
        "parentId",
        "createdAt",
        "title",
        "channelId",
        "channelTitle"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/parents/{parentId}",
        "definition": {
          "entityName": "Parent",
          "schema": {
            "$ref": "#/backend/entities/Parent"
          },
          "description": "Stores individual parent user profiles. The document ID (`parentId`) MUST match the Firebase Authentication UID (`request.auth.uid`) for direct ownership and access control."
        }
      },
      {
        "path": "/teachers/{teacherId}",
        "definition": {
          "entityName": "TeacherProfile",
          "schema": {
            "$ref": "#/backend/entities/TeacherProfile"
          },
          "description": "Stores individual teacher user profiles. The document ID (`teacherId`) MUST match the Firebase Authentication UID (`request.auth.uid`) for direct ownership and access control."
        }
      },
      {
        "path": "/classes/{classId}",
        "definition": {
          "entityName": "Class",
          "schema": {
            "$ref": "#/backend/entities/Class"
          },
          "description": "Global collection of classes created by teachers. Security rules will enforce that only the creating teacher can modify their own classes."
        }
      },
      {
        "path": "/classJoinRequests/{requestId}",
        "definition": {
          "entityName": "ClassJoinRequest",
          "schema": {
            "$ref": "#/backend/entities/ClassJoinRequest"
          },
          "description": "Stores requests from parents for their children to join a class. Teachers approve/deny these requests."
        }
      },
      {
        "path": "/parents/{parentId}/childProfiles/{childProfileId}",
        "definition": {
          "entityName": "ChildProfile",
          "schema": {
            "$ref": "#/backend/entities/ChildProfile"
          },
          "description": "Contains child profiles created by a specific parent. The `parentId` in the document matches the parent in the path, enabling authorization independence without `get()` calls. Includes denormalized 'parentId' for authorization independence."
        }
      },
      {
        "path": "/parents/{parentId}/videoQueue/{videoId}",
        "definition": {
          "entityName": "Video",
          "schema": {
            "$ref": "#/backend/entities/Video"
          },
          "description": "A queue of YouTube videos approved by a parent for their children to watch. The document ID is the YouTube video ID."
        }
      },
      {
        "path": "/parents/{parentId}/childProfiles/{childProfileId}/videoWatchEvents/{eventId}",
        "definition": {
          "entityName": "VideoWatchEvent",
          "schema": {
            "$ref": "#/backend/entities/VideoWatchEvent"
          },
          "description": "Records individual video watch events for a child profile. Each document includes denormalized 'parentId' to link directly to the owning parent, ensuring authorization independence for security rules. The 'childProfileId' in the document links to the child profile in the path."
        }
      },
      {
        "path": "/channels/{channelId}",
        "definition": {
          "entityName": "Channel",
          "schema": {
            "$ref": "#/backend/entities/Channel"
          },
          "description": "Global collection of YouTube channel metadata. This data is read-only for parents and provides a central repository for channels referenced in child content filters."
        }
      },
      {
        "path": "/contentTypes/{contentTypeId}",
        "definition": {
          "entityName": "ContentType",
          "schema": {
            "$ref": "#/backend/entities/ContentType"
          },
          "description": "Global collection of predefined content type categories. This data is read-only for parents and provides a central repository for content types referenced in child content filters."
        }
      }
    ],
    "reasoning": "The recommended Firestore structure for KidTube Safe prioritizes security, scalability, and debuggability by strictly adhering to the core design principles. The structure uses a hierarchical model for parent-owned data and segregates global, read-only data into top-level collections.\\n\\n**Authorization Independence (CRITICAL):**\\n1.  **Parent & Teacher Profiles:** The `/parents/{parentId}` and `/teachers/{teacherId}` collections use a wildcard that directly corresponds to `request.auth.uid`. This makes authentication straightforward and atomic, as rules can check `request.auth.uid == parentId` (or `teacherId`) without any `get()` operations.\\n2.  **Child Profiles:** For `/parents/{parentId}/childProfiles/{childProfileId}`, the `ChildProfile` document explicitly contains a `parentId` field. This denormalization ensures that rules can verify `request.auth.uid == resource.data.parentId` without needing to perform a `get()` operation on the parent document. The addition of `sharedWithTeacherIds` allows teachers to gain read access if their UID is in that array.\\n3.  **Video Watch Events:** Similarly, for `/parents/{parentId}/childProfiles/{childProfileId}/videoWatchEvents/{eventId}`, each `VideoWatchEvent` document is designed to include a `parentId` field (denormalized from its owning `ChildProfile`'s parent). This allows security rules to evaluate `request.auth.uid == resource.data.parentId` directly.\\n\\n**QAPs (Rules are not Filters):**\\n1.  **Hierarchical Private Data:** For `/parents/{parentId}/childProfiles` and video events, `request.auth.uid` in the path ensures `list` operations are inherently secure.\\n2.  **Global Data:** The `/channels`, `/contentTypes`, and `/classes` collections are global. Access to `/classes` is controlled by checking the `teacherId` in the document against the requester's UID, which is enforced on the client-side query and backed by security rules.\\n\\n**Structural Segregation (Strategy B):**\\n*   User-specific data (`ChildProfile`, `VideoWatchEvent`) is nested under the parent's `uid` to ensure strict ownership.\\n*   Teacher-specific data (`Class`) is in a top-level collection, queryable by `teacherId`.\\n*   Global reference data (`Channel`, `ContentType`) resides in top-level collections for broad availability."
  }
}
